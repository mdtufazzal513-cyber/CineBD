<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Your Favorites</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Player APIs -->
    <script src="https://player.vimeo.com/api/player.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // IMMEDIATE LOCAL STORAGE CHECK FOR APP NAME
        const cachedAppName = localStorage.getItem('cinebd_app_name');
        if (cachedAppName) {
            document.title = cachedAppName;
        }
    </script>

    <style>
        /* Base Styles */
        body { font-family: 'Poppins', sans-serif; overflow-x: hidden; background-color: #0f172a; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .main-content { padding-bottom: 80px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Animation for Logo */
        @keyframes slideInLogo { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .logo-anim { animation: slideInLogo 0.8s ease-out forwards; }

        /* ================= 3D CAROUSEL STYLES (UPDATED) ================= */
        .carousel-container {
            perspective: 1000px;
            width: 100%;
            height: 280px; /* Height for the carousel area */
            position: relative;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible; /* Allow 3D effect to pop out */
        }

        .carousel {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-style: preserve-3d;
            transition: transform 0.5s ease-out; /* Smooth inertia stop */
        }
        
        /* Grab Cursor Logic */
        .carousel-container:active .carousel { cursor: grabbing; }
        .carousel-container .carousel { cursor: grab; }

        .carousel__item {
            position: absolute;
            width: 140px;
            height: 210px; /* Poster Ratio */
            left: 50%;
            top: 50%;
            margin-left: -70px; /* Half of width */
            margin-top: -105px; /* Half of height */
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: #1e293b;
            border: 2px solid rgba(255, 255, 255, 0.1);
            /* Backface visibility hidden usually, but here we want to see them */
        }

        .carousel__item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            pointer-events: none; /* Prevent image drag ghosting */
        }

        .carousel__item:hover {
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.6); /* Blue glow */
            border-color: #3b82f6;
        }

        /* Responsive Size Adjustment */
        @media(min-width: 768px) {
            .carousel-container { height: 350px; }
            .carousel__item {
                width: 180px;
                height: 270px;
                margin-left: -90px;
                margin-top: -135px;
            }
        }

        /* ================= AUTH & INITIAL LOADER STYLES ================= */
        #initial-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #0f172a; z-index: 300;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .pulse-logo { font-size: 3rem; font-weight: bold; color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.95); } }

        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 200; display: none;
            align-items: center; justify-content: center;
            background-color: #0f172a; overflow: hidden; opacity: 0; transition: opacity 0.5s ease;
        }
        #auth-screen.visible { display: flex; opacity: 1; }

        .cine-bg {
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(37, 99, 235, 0.15) 0%, transparent 50%),
                linear-gradient(45deg, #0f172a 25%, #1e293b 25%, #1e293b 50%, #0f172a 50%, #0f172a 75%, #1e293b 75%, #1e293b 100%);
            background-size: 60px 60px; animation: moveBackground 20s linear infinite; opacity: 0.6; z-index: 1;
        }
        .cine-overlay { position: absolute; inset: 0; background: radial-gradient(circle, transparent 20%, #0f172a 90%); z-index: 2; }
        @keyframes moveBackground { 0% { transform: translate(0, 0); } 100% { transform: translate(60px, 60px); } }

        .auth-card {
            background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            z-index: 10; width: 90%; max-width: 400px; border-radius: 20px; padding: 2rem; position: relative; overflow: hidden;
        }
        .auth-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, #2563eb, #60a5fa, #2563eb); animation: loadingBar 2s infinite linear;
        }
        @keyframes loadingBar { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }

        /* ================= SKELETON LOADING ================= */
        .skeleton {
            background: #1e293b;
            background-image: linear-gradient(to right, #1e293b 0%, #334155 20%, #1e293b 40%, #1e293b 100%);
            background-repeat: no-repeat;
            background-size: 800px 100%;
            animation: shimmer 1.5s infinite linear;
            border-radius: 8px;
        }
        @keyframes shimmer { 0% { background-position: -800px 0; } 100% { background-position: 800px 0; } }
        .sk-banner { width: 100%; height: 100%; }
        .sk-title { width: 150px; height: 24px; margin-bottom: 16px; border-radius: 4px; }
        .sk-row { display: flex; gap: 16px; overflow: hidden; margin-bottom: 32px; }
        .sk-card { width: 128px; height: 192px; flex-shrink: 0; }
        @media(min-width: 768px) { .sk-card { width: 160px; height: 240px; } }

        /* ================= PLAYER STYLES ================= */
        #watch-page {
            background-color: #0f172a; min-height: 100vh; width: 100%;
            position: fixed; top: 0; left: 0; z-index: 100; overflow-y: auto;
        }
        .ad-spacer { width: 100%; height: 60px; background: transparent; }
        :root { --primary: #2563eb; --panel-bg: #1e293b; }
        .player-wrapper {
            width: 100%; background: #000; border-radius: 12px; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative;
            border: 1px solid #334155; margin-bottom: 20px;
        }
        .video-screen { position: relative; width: 100%; padding-bottom: 56.25%; background: #000; }
        .video-screen video, .video-screen iframe, .video-screen div#embedContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        .security-mask { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 50; }
        .video-loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 40; display: none; pointer-events: none;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%; border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .controls { background: var(--panel-bg); padding: 15px 20px; display: flex; flex-direction: column; gap: 12px; border-top: 1px solid #334155; z-index: 60; position: relative; }
        .progress-row { display: flex; align-items: center; gap: 15px; width: 100%; }
        .time-txt { font-size: 12px; color: #94a3b8; min-width: 60px; font-weight: 500; }
        .time-txt.right { text-align: right; }
        input[type="range"] { flex-grow: 1; height: 4px; background: #475569; border-radius: 5px; outline: none; -webkit-appearance: none; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px rgba(37, 99, 235, 0.5); transition: 0.2s; }
        .buttons-row { display: flex; align-items: center; justify-content: space-between; position: relative; padding: 5px 0; }
        .center-controls { position: absolute; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 20px; }
        .skip-btn { background: none; border: none; color: #cbd5e1; font-size: 20px; cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; }
        .skip-btn span { font-size: 9px; position: absolute; margin-top: 24px; font-weight: bold; color: #94a3b8; }
        .play-btn { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #2563eb, #1d4ed8); border: none; color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); transition: transform 0.2s; }
        .play-btn:active { transform: scale(0.95); }
        .vol-btn { background: none; border: none; color: #cbd5e1; font-size: 18px; cursor: pointer; padding: 8px; }
        .server-box { text-align: center; width: 100%; margin-top: 20px; }
        .server-label { display: block; margin-bottom: 10px; color: #94a3b8; font-size: 12px; letter-spacing: 1px; text-transform: uppercase; }
        .btn-list { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
        .sv-btn { background: #0f172a; color: #94a3b8; border: 1px solid #334155; padding: 10px 20px; border-radius: 50px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; font-family: inherit; font-size: 13px; }
        .sv-btn:hover { border-color: var(--primary); color: #fff; transform: translateY(-2px); }
        .sv-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3); font-weight: 600; }
        .category-grid-item { background-image: linear-gradient(to top right, #1e40af, #3b82f6); }
        
        /* AD Container Helper */
        .ad-container { display: flex; justify-content: center; align-items: center; margin: 10px 0; overflow: hidden; min-height: 50px; }

        /* Series / Episode List Styles */
        .ep-list-item {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ep-list-item:hover { background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); }
        .ep-list-item i { color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans">

    <!-- ================= INITIAL APP LOADER (SPLASH SCREEN) ================= -->
    <div id="initial-loader">
        <div class="pulse-logo dynamic-app-name">Cine<span class="text-blue-500">BD</span></div>
        <p class="text-gray-400 text-sm mt-4">Loading Experience...</p>
    </div>

    <!-- ================= AUTHENTICATION SCREEN ================= -->
    <div id="auth-screen">
        <div class="cine-bg"></div>
        <div class="cine-overlay"></div>
        
        <div class="auth-card animate-fade-in-up">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-white mb-2 dynamic-app-name">Cine<span class="text-blue-500">BD</span></h1>
                <p class="text-gray-400 text-sm">Your Unlimited Movie Destination</p>
            </div>
            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">Email Address</label>
                    <div class="relative">
                        <i class="fas fa-envelope absolute left-3 top-3.5 text-gray-500"></i>
                        <input type="email" id="login-email" placeholder="name@example.com" class="w-full bg-slate-800/50 border border-slate-600 rounded-lg py-3 pl-10 pr-3 focus:outline-none focus:border-blue-500 text-sm text-white" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">Password</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-3 top-3.5 text-gray-500"></i>
                        <input type="password" id="login-password" placeholder="••••••••" class="w-full bg-slate-800/50 border border-slate-600 rounded-lg py-3 pl-10 pr-3 focus:outline-none focus:border-blue-500 text-sm text-white" required>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-lg transition-all transform active:scale-95">Log In</button>
            </form>
            <!-- Signup Form -->
            <form id="signup-form" class="space-y-4 hidden">
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">Full Name</label>
                    <div class="relative">
                        <i class="fas fa-user absolute left-3 top-3.5 text-gray-500"></i>
                        <input type="text" id="signup-name" placeholder="John Doe" class="w-full bg-slate-800/50 border border-slate-600 rounded-lg py-3 pl-10 pr-3 focus:outline-none focus:border-blue-500 text-sm text-white" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">Email Address</label>
                    <div class="relative">
                        <i class="fas fa-envelope absolute left-3 top-3.5 text-gray-500"></i>
                        <input type="email" id="signup-email" placeholder="name@example.com" class="w-full bg-slate-800/50 border border-slate-600 rounded-lg py-3 pl-10 pr-3 focus:outline-none focus:border-blue-500 text-sm text-white" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">Password</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-3 top-3.5 text-gray-500"></i>
                        <input type="password" id="signup-password" placeholder="Min. 6 characters" class="w-full bg-slate-800/50 border border-slate-600 rounded-lg py-3 pl-10 pr-3 focus:outline-none focus:border-blue-500 text-sm text-white" required>
                    </div>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-3 rounded-lg shadow-lg transition-all transform active:scale-95">Create Account</button>
            </form>
            <div class="flex items-center my-6">
                <div class="flex-grow border-t border-gray-600"></div>
                <span class="flex-shrink-0 mx-4 text-gray-500 text-xs uppercase">Or continue with</span>
                <div class="flex-grow border-t border-gray-600"></div>
            </div>
            <button id="google-btn" class="w-full bg-white text-gray-900 font-medium py-3 rounded-lg hover:bg-gray-100 transition-colors flex items-center justify-center gap-2">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="Google">
                <span>Google</span>
            </button>
            <div class="text-center mt-6">
                <p id="toggle-text-login" class="text-sm text-gray-400">
                    Don't have an account? <button onclick="toggleAuthMode('signup')" class="text-blue-400 hover:text-blue-300 font-semibold ml-1">Sign Up</button>
                </p>
                <p id="toggle-text-signup" class="text-sm text-gray-400 hidden">
                    Already have an account? <button onclick="toggleAuthMode('login')" class="text-blue-400 hover:text-blue-300 font-semibold ml-1">Log In</button>
                </p>
            </div>
            <p id="auth-error" class="text-red-400 text-xs text-center mt-4 min-h-[20px]"></p>
        </div>
    </div>

    <!-- ================= MAIN APP CONTAINER ================= -->
    <div id="app-container" class="max-w-4xl mx-auto hidden">

        <!-- Main Content Area -->
        <main class="main-content">

            <!-- Home Page -->
            <div id="home-page" class="page active p-4">
                <header class="sticky top-0 z-50 flex justify-between items-center py-2 -mx-4 px-4 bg-slate-900/70 backdrop-blur-xl border-b border-white/5 shadow-lg mb-6 transition-all">
                    <!-- Dynamic App Name -->
                    <h1 class="text-xl font-bold text-white logo-anim dynamic-app-name flex-shrink-0">Cine<span class="text-blue-500">BD</span></h1>
                    
                    <!-- AD LOCATION 1: Header -->
                    <div class="flex-grow flex justify-end md:justify-center mx-2 overflow-hidden">
                        <iframe srcdoc="<script>
                              atOptions = {
                                'key' : 'aa465b71c480195a3ddce17207d3b9d7',
                                'format' : 'iframe',
                                'height' : 50,
                                'width' : 320,
                                'params' : {}
                              };
                            </script>
                            <script src='https://www.highperformanceformat.com/aa465b71c480195a3ddce17207d3b9d7/invoke.js'></script>"
                            width="320" height="50" scrolling="no" frameborder="0" style="border:none; overflow:hidden;"></iframe>
                    </div>

                    <div class="flex items-center gap-4 hidden md:flex">
                        <span id="header-user-name" class="text-xs text-blue-300 font-medium"></span>
                    </div>
                </header>
                
                <!-- NEW 3D POSTER SLIDER -->
                <div class="carousel-container">
                    <div class="carousel" id="carousel">
                        <!-- Dynamic Banners Generated Here -->
                        <div class="skeleton w-32 h-48 rounded-lg mx-auto mt-10"></div>
                    </div>
                </div>
                <!-- END NEW SLIDER -->
                
                <div id="movie-carousels-container">
                    <div class="mb-8 skeleton-group">
                        <div class="skeleton sk-title"></div>
                        <div class="sk-row">
                            <div class="skeleton sk-card"></div>
                            <div class="skeleton sk-card"></div>
                            <div class="skeleton sk-card"></div>
                            <div class="skeleton sk-card"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Page -->
            <div id="search-page" class="page p-4">
                <h2 class="text-2xl font-bold mb-4">Search Movies</h2>
                <div class="relative">
                    <input type="text" id="search-input" class="w-full bg-slate-800 text-white rounded-lg p-3 pl-10 focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Search title, 'new', 'trending'...">
                    <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                </div>
                
                <!-- AD LOCATION 4 -->
                <div class="ad-container mt-4">
                     <iframe srcdoc="<script>
                          atOptions = {
                            'key' : 'aa465b71c480195a3ddce17207d3b9d7',
                            'format' : 'iframe',
                            'height' : 50,
                            'width' : 320,
                            'params' : {}
                          };
                        </script>
                        <script src='https://www.highperformanceformat.com/aa465b71c480195a3ddce17207d3b9d7/invoke.js'></script>"
                        width="320" height="50" scrolling="no" frameborder="0" style="border:none; overflow:hidden;"></iframe>
                </div>

                <div id="search-history-container" class="mt-4 hidden">
                    <p class="text-xs text-gray-500 uppercase mb-2">Recent Searches</p>
                    <div id="search-history-chips" class="flex flex-wrap gap-2"></div>
                    <button onclick="clearSearchHistory()" class="text-xs text-red-400 mt-2 hover:underline">Clear History</button>
                </div>
                <div id="search-results" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-6"></div>
            </div>

            <!-- Categories Page -->
            <div id="categories-page" class="page p-4">
                <h2 class="text-2xl font-bold mb-4">All Categories</h2>
                
                <!-- AD LOCATION 5 -->
                <div class="ad-container mb-4">
                     <iframe srcdoc="<script>
                          atOptions = {
                            'key' : 'aa465b71c480195a3ddce17207d3b9d7',
                            'format' : 'iframe',
                            'height' : 50,
                            'width' : 320,
                            'params' : {}
                          };
                        </script>
                        <script src='https://www.highperformanceformat.com/aa465b71c480195a3ddce17207d3b9d7/invoke.js'></script>"
                        width="320" height="50" scrolling="no" frameborder="0" style="border:none; overflow:hidden;"></iframe>
                </div>

                <div id="categories-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
            </div>

            <!-- Notification Page -->
            <div id="notifications-page" class="page p-4">
                <h2 class="text-2xl font-bold mb-6">Notifications</h2>
                
                <!-- Social Media Links -->
                <div class="mb-8">
                    <h3 class="text-sm font-semibold text-gray-400 uppercase mb-3">Community Links</h3>
                    <div id="social-links-container" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                </div>

                <!-- Admin Notifications -->
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 uppercase mb-3">Announcements</h3>
                    
                    <!-- AD LOCATION 6 -->
                    <div class="ad-container mb-3">
                         <iframe srcdoc="<script>
                              atOptions = {
                                'key' : 'aa465b71c480195a3ddce17207d3b9d7',
                                'format' : 'iframe',
                                'height' : 50,
                                'width' : 320,
                                'params' : {}
                              };
                            </script>
                            <script src='https://www.highperformanceformat.com/aa465b71c480195a3ddce17207d3b9d7/invoke.js'></script>"
                            width="320" height="50" scrolling="no" frameborder="0" style="border:none; overflow:hidden;"></iframe>
                    </div>

                    <div id="notifications-container" class="space-y-3"></div>
                </div>
            </div>
            
            <!-- Category Movies Page -->
            <div id="category-movies-page" class="page p-4">
                <div class="sticky top-0 z-40 bg-slate-900/90 backdrop-blur-lg -mx-4 px-4 py-3 mb-4 flex items-center border-b border-white/5">
                    <button onclick="goBack()" class="mr-4 bg-slate-800 hover:bg-slate-700 w-8 h-8 rounded-full flex items-center justify-center transition-colors">
                        <i class="fas fa-arrow-left text-sm"></i>
                    </button>
                    <h2 id="selected-category-title" class="text-lg font-bold">Category</h2>
                </div>
                <div id="category-movies-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
            </div>

            <!-- Profile Page -->
            <div id="profile-page" class="page p-4">
                <h2 class="text-2xl font-bold mb-6">My Profile</h2>
                <div class="text-center mt-6">
                    <div class="relative inline-block">
                        <div class="w-24 h-24 bg-gradient-to-tr from-blue-600 to-cyan-500 rounded-full mx-auto flex items-center justify-center mb-4 shadow-lg ring-4 ring-slate-800">
                            <span id="profile-initial" class="text-4xl font-bold text-white">U</span>
                        </div>
                        <div class="absolute bottom-4 right-0 bg-green-500 w-5 h-5 rounded-full border-2 border-slate-900"></div>
                    </div>
                    <h3 id="profile-name" class="text-xl font-bold text-white">Loading...</h3>
                    <p id="profile-email" class="text-gray-400 mb-8 text-sm">loading@example.com</p>
                    <div class="bg-slate-800 rounded-xl p-6 text-left max-w-sm mx-auto shadow-md border border-slate-700">
                        <div class="flex items-center justify-between border-b border-slate-700 pb-3 mb-3">
                            <span class="text-gray-300 text-sm"><i class="fas fa-crown text-yellow-500 mr-2"></i>Membership</span>
                            <span class="text-xs font-bold bg-blue-600 px-2 py-1 rounded text-white">FREE</span>
                        </div>
                    </div>
                    <button onclick="handleLogout()" class="mt-8 px-6 py-3 bg-red-600/10 hover:bg-red-600 text-red-500 hover:text-white border border-red-600/50 rounded-lg transition-all flex items-center justify-center mx-auto gap-2">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Movie Details Page -->
            <div id="movie-details-page" class="page">
                <div id="movie-details-content" class="relative"></div>
            </div>

            <!-- Watch Page -->
            <div id="watch-page" class="page hidden">
                <div class="ad-spacer"></div>
                <div class="max-w-4xl mx-auto p-4">
                    <button onclick="closePlayer()" class="mb-4 bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg flex items-center text-gray-300 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Details
                    </button>
                    <h2 id="player-movie-title" class="text-xl font-bold mb-4 text-white">Movie Title</h2>
                    <div class="player-wrapper">
                        <div class="video-screen">
                            <div class="video-loader" id="videoLoader">
                                <div class="spinner"></div>
                            </div>
                            <div class="security-mask" onclick="togglePlay()"></div>
                            <video id="directVideo" style="display:none;"></video>
                            <div id="embedContainer"></div>
                        </div>
                        <div class="controls">
                            <div class="progress-row">
                                <span class="time-txt" id="currTime">00:00</span>
                                <input type="range" id="seekSlider" value="0" min="0" step="1" oninput="seekVideo()">
                                <span class="time-txt right" id="totalTime">00:00</span>
                            </div>
                            <div class="buttons-row">
                                <button class="vol-btn" onclick="toggleMute()"><i class="fas fa-volume-up" id="volIcon"></i></button>
                                <div class="center-controls">
                                    <button class="skip-btn" onclick="skip(-10)"> <i class="fas fa-rotate-left"></i><span>10</span> </button>
                                    <button class="play-btn" id="playBtn" onclick="togglePlay()"> <i class="fas fa-play"></i> </button>
                                    <button class="skip-btn" onclick="skip(10)"> <i class="fas fa-rotate-right"></i><span>10</span> </button>
                                </div>
                                <div style="width: 40px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AD LOCATION 3 -->
                    <div class="ad-container mt-4 mb-2">
                         <iframe srcdoc="<script>
                              atOptions = {
                                'key' : 'aa465b71c480195a3ddce17207d3b9d7',
                                'format' : 'iframe',
                                'height' : 50,
                                'width' : 320,
                                'params' : {}
                              };
                            </script>
                            <script src='https://www.highperformanceformat.com/aa465b71c480195a3ddce17207d3b9d7/invoke.js'></script>"
                            width="320" height="50" scrolling="no" frameborder="0" style="border:none; overflow:hidden;"></iframe>
                    </div>

                    <div class="server-box">
                        <span class="server-label">Select Server</span>
                        <div class="btn-list" id="server-buttons-container"></div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-4xl mx-auto h-20 bg-slate-800/80 backdrop-blur-xl border-t border-slate-700 shadow-t-lg z-40">
            <div class="flex justify-around items-center h-full">
                <button data-page="home-page" class="nav-btn text-blue-500 flex flex-col items-center">
                    <i class="fas fa-home text-2xl"></i><span class="text-xs mt-1">Home</span>
                </button>
                <button data-page="search-page" class="nav-btn text-gray-400 flex flex-col items-center">
                    <i class="fas fa-search text-2xl"></i><span class="text-xs mt-1">Search</span>
                </button>
                <button data-page="categories-page" class="nav-btn text-gray-400 flex flex-col items-center">
                    <i class="fas fa-th-large text-2xl"></i><span class="text-xs mt-1">Categories</span>
                </button>
                <button data-page="notifications-page" class="nav-btn text-gray-400 flex flex-col items-center">
                    <i class="fas fa-bell text-2xl"></i><span class="text-xs mt-1">Notice</span>
                </button>
                <button data-page="profile-page" class="nav-btn text-gray-400 flex flex-col items-center">
                    <i class="fas fa-user text-2xl"></i><span class="text-xs mt-1">Profile</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDcMEwggMx5nuIngnNf4QdcmTzXufPlbOk",
            authDomain: "cinebd-513.firebaseapp.com",
            databaseURL: "https://cinebd-513-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cinebd-513",
            storageBucket: "cinebd-513.firebasestorage.app",
            messagingSenderId: "525903162217",
            appId: "1:525903162217:web:afc2f4a6919db77dc32bf8"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        let allMovies = {};
        let allCategories = {};
        
        // --- 3D CAROUSEL VARIABLES ---
        let rotationY = 0;
        let startX = 0;
        let isDragging = false;
        let autoRotate = true;
        let carouselEl = null;

        const authScreen = document.getElementById('auth-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const authError = document.getElementById('auth-error');
        const initialLoader = document.getElementById('initial-loader');

        window.toggleAuthMode = (mode) => {
            authError.textContent = '';
            if (mode === 'signup') {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                document.getElementById('toggle-text-login').classList.add('hidden');
                document.getElementById('toggle-text-signup').classList.remove('hidden');
            } else {
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                document.getElementById('toggle-text-signup').classList.add('hidden');
                document.getElementById('toggle-text-login').classList.remove('hidden');
            }
        };

        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            auth.createUserWithEmailAndPassword(document.getElementById('signup-email').value, document.getElementById('signup-password').value)
                .then((u) => u.user.updateProfile({ displayName: document.getElementById('signup-name').value }))
                .catch((e) => authError.textContent = e.message.replace("Firebase: ", ""));
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value)
                .catch((e) => authError.textContent = e.message.replace("Firebase: ", ""));
        });

        document.getElementById('google-btn').addEventListener('click', () => {
            auth.signInWithPopup(googleProvider).catch((e) => authError.textContent = e.message);
        });

        window.handleLogout = () => {
            auth.signOut();
            localStorage.removeItem('last_page_id');
            localStorage.removeItem('last_movie_id');
        };

        // --- LIVE USERS PRESENCE SYSTEM ---
        function setupPresence(user) {
            const onlineRef = db.ref('online_users/' + user.uid);
            const connectedRef = db.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    onlineRef.onDisconnect().remove();
                    onlineRef.set({
                        name: user.displayName || "User",
                        last_seen: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });
        }

        // --- AUTH STATE & LOADING ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                authScreen.classList.remove('visible');
                authScreen.style.display = 'none'; 
                appContainer.classList.remove('hidden');
                updateUserProfile(user);
                setupPresence(user);
                
                const lastPage = localStorage.getItem('last_page_id');
                const lastMovie = localStorage.getItem('last_movie_id');

                if(lastPage && lastPage !== 'home-page') {
                    if(lastPage !== 'movie-details-page' && lastPage !== 'watch-page') {
                        showPage(lastPage, false);
                    }
                } else {
                    showPage('home-page', true);
                }
                
                initialLoader.style.opacity = '0';
                setTimeout(() => {
                    initialLoader.style.display = 'none';
                    loadInitialData();
                }, 500);

            } else {
                authScreen.style.display = 'flex';
                setTimeout(() => authScreen.classList.add('visible'), 10);
                appContainer.classList.add('hidden');
                initialLoader.style.opacity = '0';
                setTimeout(() => initialLoader.style.display = 'none', 500);
            }
        });

        function updateUserProfile(user) {
            document.getElementById('header-user-name').textContent = `Hi, ${user.displayName ? user.displayName.split(' ')[0] : 'User'}`;
            document.getElementById('profile-name').textContent = user.displayName || "CineBD User";
            document.getElementById('profile-email').textContent = user.email;
            document.getElementById('profile-initial').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U';
        }

        const pages = document.querySelectorAll('.page');
        const navBtns = document.querySelectorAll('.nav-btn');

        window.onpopstate = (event) => {
            if (event.state && event.state.page) {
                showPage(event.state.page, false);
                if(event.state.page === 'movie-details-page' && event.state.movieId) {
                    showMovieDetails(event.state.movieId, false);
                }
            } else {
                showPage('home-page', false);
            }
        };

        const showPage = (pageId, pushToHistory = true) => {
            pages.forEach(page => page.classList.toggle('active', page.id === pageId));
            navBtns.forEach(btn => {
                btn.classList.toggle('text-blue-500', btn.dataset.page === pageId);
                btn.classList.toggle('text-gray-400', btn.dataset.page !== pageId);
            });
            
            localStorage.setItem('last_page_id', pageId);
            if (pushToHistory) history.pushState({ page: pageId }, null, "");

            if(pageId === 'search-page') {
                renderSearchHistory();
                document.getElementById('search-input').value = '';
                document.getElementById('search-results').innerHTML = '';
            }
        };

        window.goBack = () => history.back();
        navBtns.forEach(btn => btn.addEventListener('click', () => showPage(btn.dataset.page)));

        // --- GLOBAL VARS ---
        let playerMode = 'direct';
        let vimeoPlayer, ytPlayer, updateInterval;
        let searchHistory = JSON.parse(localStorage.getItem('cinebd_search_history')) || [];

        // --- 3D CAROUSEL LOGIC START ---
        const renderBanners = (banners) => {
            carouselEl = document.getElementById('carousel');
            if (!banners || !carouselEl) return;
            carouselEl.innerHTML = ''; 

            const bannerList = Object.values(banners); // Convert object to array
            const count = bannerList.length;
            if(count === 0) return;

            // Calculate Radius based on screen size to keep items visible
            const isMobile = window.innerWidth < 768;
            const radius = isMobile ? 240 : 380; // Distance from center
            const theta = 360 / count;

            bannerList.forEach((b, index) => {
                const angle = theta * index;
                const item = document.createElement('div');
                item.className = 'carousel__item';
                
                // Smart Poster Logic: Try to find vertical poster from movieId, else use banner image
                let imgSrc = b.imageUrl;
                if(b.movieId && allMovies[b.movieId] && allMovies[b.movieId].posterUrl) {
                    imgSrc = allMovies[b.movieId].posterUrl;
                }

                item.innerHTML = `<img src="${imgSrc}" alt="Banner">`;
                
                // Set initial position
                item.style.transform = `rotateY(${angle}deg) translateZ(${radius}px)`;
                
                // Add Click Event (Distinguish Click vs Drag)
                item.addEventListener('click', (e) => {
                    // Only trigger if not dragging
                    if(!isDragging && b.movieId) {
                        showMovieDetails(b.movieId);
                    }
                });

                carouselEl.appendChild(item);
            });

            // Re-initialize variables for new content
            rotationY = 0;
            rotateCarousel(radius);
            
            // Setup events only once (or clear old ones) - Simple global handler here
            setupCarouselEvents();
        };

        function rotateCarousel(radiusOverride) {
            if(!carouselEl) return;
            const isMobile = window.innerWidth < 768;
            const r = radiusOverride || (isMobile ? 240 : 380);
            carouselEl.style.transform = `translateZ(-${r}px) rotateY(${rotationY}deg)`;
        }

        // Animation Loop
        function animateCarousel() {
            if(autoRotate && !isDragging && carouselEl){
                rotationY -= 0.2; // Slow auto rotation
                rotateCarousel();
            }
            requestAnimationFrame(animateCarousel);
        }
        
        // Start Loop
        requestAnimationFrame(animateCarousel);

        function setupCarouselEvents() {
            const container = document.querySelector('.carousel-container');
            if(!container) return;

            // Mouse Events
            container.addEventListener('mousedown', e => {
                isDragging = true;
                startX = e.clientX;
                autoRotate = false;
                carouselEl.style.transition = 'none'; // Instant follow
            });

            window.addEventListener('mouseup', e => {
                if(isDragging) {
                    isDragging = false;
                    autoRotate = true;
                    carouselEl.style.transition = 'transform 0.5s ease-out';
                }
            });

            window.addEventListener('mousemove', e => {
                if(isDragging){
                    const deltaX = e.clientX - startX;
                    startX = e.clientX;
                    rotationY += deltaX * 0.5; // Sensitivity
                    rotateCarousel();
                }
            });

            // Touch Events (Mobile)
            container.addEventListener('touchstart', e => {
                isDragging = true;
                startX = e.touches[0].clientX;
                autoRotate = false;
                carouselEl.style.transition = 'none';
            });

            window.addEventListener('touchend', e => {
                if(isDragging) {
                    isDragging = false;
                    autoRotate = true;
                    carouselEl.style.transition = 'transform 0.5s ease-out';
                }
            });

            window.addEventListener('touchmove', e => {
                if(isDragging){
                    const deltaX = e.touches[0].clientX - startX;
                    startX = e.touches[0].clientX;
                    rotationY += deltaX * 0.5;
                    rotateCarousel();
                }
            });
        }
        // --- 3D CAROUSEL LOGIC END ---


        const renderHomePage = () => {
            const container = document.getElementById('movie-carousels-container');
            if(!container) return;
            container.innerHTML = '';

            // Updated Time Logic
            const now = new Date();
            const allMoviesArr = Object.entries(allMovies);

            // --- UPCOMING MOVIES SECTION ---
            // Logic: IsUpcoming AND Release Date (DateTime) is in Future
            const upcomingMovies = allMoviesArr.filter(([_, m]) => {
                const release = m.releaseDate ? new Date(m.releaseDate) : new Date(0);
                return m.isUpcoming && release > now;
            });

            // Helper for Movie Poster + Title text
            const movieCard = (id, m, isUp = false) => {
                 const typeLabel = (m.contentType === 'series') ? '<span class="absolute top-1 right-1 bg-purple-600 text-white text-[9px] px-1 rounded shadow">SERIES</span>' : '';
                 return `
                <div class="flex-shrink-0 w-32 md:w-40 mr-4 cursor-pointer relative" onclick="showMovieDetails('${id}')">
                    <img src="${m.posterUrl}" class="w-full h-48 md:h-60 object-cover rounded-lg shadow-md ${isUp ? 'grayscale hover:grayscale-0' : 'hover:scale-105'} transition-all duration-300">
                    ${typeLabel}
                    <p class="mt-2 text-xs font-medium text-white truncate w-full text-center">${m.title}</p>
                    ${isUp ? `<div class="absolute bottom-6 left-0 w-full bg-blue-600 text-white text-[10px] text-center py-1 rounded-b-lg font-bold">COMING SOON</div>` : ''}
                </div>`;
            };

            if (upcomingMovies.length > 0) {
                const html = upcomingMovies.map(([id, m]) => movieCard(id, m, true)).join('');
                container.innerHTML += `<div class="mb-8"><h2 class="text-xl font-bold mb-4 text-blue-400"><i class="fas fa-calendar-alt mr-2"></i>Upcoming Movies</h2><div class="flex overflow-x-auto pb-4 no-scrollbar">${html}</div></div>`;
            }

            // --- NORMAL CATEGORIES ---
            Object.values(allCategories).forEach(cat => {
                // Filter: Category matches AND (Not upcoming OR Release date passed)
                const movies = allMoviesArr.filter(([_, m]) => {
                    const release = m.releaseDate ? new Date(m.releaseDate) : new Date(0);
                    const isReleased = !m.isUpcoming || release <= now;
                    return m.category === cat.name && isReleased;
                });

                if (movies.length > 0) {
                    const html = movies.map(([id, m]) => movieCard(id, m)).join('');
                    container.innerHTML += `<div class="mb-8"><h2 class="text-xl font-bold mb-4">${cat.name}</h2><div class="flex overflow-x-auto pb-4 no-scrollbar">${html}</div></div>`;
                }
            });
        };

        // --- RENDER NOTIFICATIONS & SOCIALS ---
        const renderSocials = (socials) => {
            const container = document.getElementById('social-links-container');
            if(!container) return;
            if(!socials) { container.innerHTML = '<p class="text-xs text-gray-500 col-span-2">No links added.</p>'; return; }
            
            container.innerHTML = Object.values(socials).map(item => `
                <a href="${item.url}" target="_blank" class="flex items-center bg-slate-800 p-4 rounded-lg hover:bg-slate-700 transition-colors border border-slate-700">
                    <div class="w-10 h-10 rounded-full bg-blue-600/20 flex items-center justify-center mr-3 text-blue-500">
                        <i class="${item.icon || 'fas fa-link'} text-xl"></i>
                    </div>
                    <div>
                        <p class="font-bold text-sm">${item.name}</p>
                        <p class="text-[10px] text-gray-400">Tap to visit</p>
                    </div>
                </a>
            `).join('');
        };

        const renderNotifications = (notifs) => {
            const container = document.getElementById('notifications-container');
            if(!container) return;
            if(!notifs) { container.innerHTML = '<p class="text-xs text-gray-500">No notifications.</p>'; return; }
            
            const list = Object.values(notifs).sort((a,b) => b.timestamp - a.timestamp);
            
            container.innerHTML = list.map(item => `
                <div class="bg-slate-800 p-4 rounded-lg border-l-4 border-blue-500 shadow-sm">
                    <h4 class="font-bold text-sm text-white mb-1">${item.title}</h4>
                    <p class="text-xs text-gray-300 leading-relaxed">${item.message}</p>
                    <p class="text-[10px] text-gray-500 mt-2 text-right">${new Date(item.timestamp).toLocaleDateString()}</p>
                </div>
            `).join('');
        };

        // --- SEARCH LOGIC (PRO) ---
        const searchInput = document.getElementById('search-input');
        const historyContainer = document.getElementById('search-history-container');
        
        function renderSearchHistory() {
            const container = document.getElementById('search-history-chips');
            container.innerHTML = '';
            if(searchHistory.length > 0) {
                historyContainer.classList.remove('hidden');
                searchHistory.forEach(term => {
                    const chip = document.createElement('div');
                    chip.className = 'bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-full text-sm cursor-pointer transition-colors';
                    chip.innerText = term;
                    chip.addEventListener('click', () => {
                        searchInput.value = term;
                        performSearch(term);
                    });
                    container.appendChild(chip);
                });
            } else {
                historyContainer.classList.add('hidden');
            }
        }

        function addToHistory(term) {
            searchHistory = searchHistory.filter(t => t !== term);
            searchHistory.unshift(term);
            if(searchHistory.length > 5) searchHistory.pop();
            localStorage.setItem('cinebd_search_history', JSON.stringify(searchHistory));
        }

        window.clearSearchHistory = function() {
            searchHistory = [];
            localStorage.removeItem('cinebd_search_history');
            renderSearchHistory();
        }

        function performSearch(term) {
            const container = document.getElementById('search-results');
            historyContainer.classList.add('hidden');
            const now = new Date();
            const lowerTerm = term.toLowerCase();
            const currentYear = now.getFullYear();

            // Filter: (Not upcoming OR Release date passed) AND Match Logic
            const results = Object.entries(allMovies).filter(([_, m]) => {
                const release = m.releaseDate ? new Date(m.releaseDate) : new Date(0);
                const isReleased = !m.isUpcoming || release <= now;
                
                if(!isReleased) return false;

                // Professional Search Logic
                if (lowerTerm.includes('new movie') || lowerTerm.includes('new')) {
                    return parseInt(m.year) === currentYear;
                }
                if (lowerTerm.includes('trending')) {
                    // Assuming rating > 7 is trending
                    return parseFloat(m.rating) >= 7.0;
                }

                // Default Title Search
                return m.title.toLowerCase().includes(lowerTerm);
            });

            if (results.length > 0) {
                // Additional Sort for "new"
                if(lowerTerm.includes('new')) {
                    results.sort((a,b) => b[1].year - a[1].year); // Newest first
                }

                container.innerHTML = results.map(([id, m]) => `
                <div class="cursor-pointer" onclick="clickSearchResult('${id}', '${m.title}')">
                    <img src="${m.posterUrl}" class="w-full h-auto object-cover rounded-lg shadow-md">
                    <p class="mt-2 text-sm text-gray-300 font-semibold truncate">${m.title}</p>
                </div>`).join('');
            } else {
                container.innerHTML = '<p class="col-span-full text-center text-gray-400">No movies found.</p>';
            }
        }

        window.clickSearchResult = function(id, title) {
            addToHistory(title);
            showMovieDetails(id);
        };

        searchInput.addEventListener('input', (e) => {
            const term = e.target.value;
            if (term.length < 1) {
                document.getElementById('search-results').innerHTML = '';
                renderSearchHistory();
                return;
            }
            performSearch(term);
        });

        // --- CATEGORIES ---
        const renderCategoriesPage = () => {
            const container = document.getElementById('categories-grid');
            if(!container) return;
            const icons = ['fa-film', 'fa-laugh-beam', 'fa-skull-crossbones', 'fa-heart', 'fa-space-shuttle'];
            container.innerHTML = Object.values(allCategories).map((cat, i) => `
                <div onclick="openCategoryMovies('${cat.name}')" class="category-grid-item flex flex-col items-center justify-center p-6 rounded-lg shadow-lg text-center cursor-pointer hover:scale-105 transition-transform duration-200">
                    <i class="fas ${icons[i % icons.length]} text-4xl mb-3"></i><span class="font-semibold text-lg">${cat.name}</span>
                </div>`).join('');
        };

        window.openCategoryMovies = (categoryName) => {
            document.getElementById('selected-category-title').textContent = categoryName;
            const container = document.getElementById('category-movies-grid');
            const now = new Date();
            
            const results = Object.entries(allMovies).filter(([_, m]) => {
                const release = m.releaseDate ? new Date(m.releaseDate) : new Date(0);
                const isReleased = !m.isUpcoming || release <= now;
                return m.category === categoryName && isReleased;
            });
            
            if (results.length > 0) {
                container.innerHTML = results.map(([id, m]) => `
                <div class="cursor-pointer" onclick="showMovieDetails('${id}')">
                    <img src="${m.posterUrl}" class="w-full h-auto object-cover rounded-lg shadow-md">
                    <p class="mt-2 text-sm text-gray-300 font-semibold truncate">${m.title}</p>
                </div>`).join('');
            } else {
                container.innerHTML = '<p class="col-span-full text-center text-gray-400">No movies found in this category.</p>';
            }
            showPage('category-movies-page');
        };

        // --- PLAYER LOGIC ---
        function getYouTubeID(url) {
            let regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            let match = url.match(regExp);
            return (match && match[2].length == 11) ? match[2] : url;
        }

        const setBuffering = (state) => {
            const loader = document.getElementById('videoLoader');
            if(loader) loader.style.display = state ? 'block' : 'none';
        }

        window.loadServer = function(btn, type, url) {
            if(!url) return alert("Server link not available");
            document.querySelectorAll('.sv-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            clearInterval(updateInterval);
            playerMode = type;
            isPlaying = false;
            updateUI();
            setBuffering(true);
            const directVid = document.getElementById('directVideo');
            const embedDiv = document.getElementById('embedContainer');
            const slider = document.getElementById('seekSlider');
            directVid.style.display = 'none';
            directVid.pause();
            directVid.src = "";
            embedDiv.innerHTML = '';
            slider.value = 0;
            document.getElementById('currTime').innerText = "00:00";
            document.getElementById('totalTime').innerText = "00:00";
            if (type === 'direct') {
                if(url.includes('dropbox.com')) url = url.replace('dl=0', 'raw=1');
                directVid.src = url;
                directVid.style.display = 'block';
                directVid.onloadstart = () => setBuffering(true);
                directVid.onwaiting = () => setBuffering(true);
                directVid.onplaying = () => { setBuffering(false); isPlaying = true; updateUI(); };
                directVid.oncanplay = () => setBuffering(false);
                directVid.onended = () => { isPlaying = false; updateUI(); };
                directVid.onpause = () => { isPlaying = false; updateUI(); };
                directVid.ontimeupdate = () => { if(!directVid.seeking) updateProgress(directVid.currentTime, directVid.duration); };
                directVid.load();
                directVid.play().catch(e => console.log("Autoplay blocked"));
            }
            else if (type === 'vimeo') {
                if(url.includes('vimeo.com/')) url = url.split('/').pop();
                embedDiv.innerHTML = `<iframe src="https://player.vimeo.com/video/${url}?badge=0&autopause=0&player_id=0" width="100%" height="100%" frameborder="0" allow="autoplay; fullscreen" title="Vimeo"></iframe>`;
                let iframe = embedDiv.querySelector('iframe');
                vimeoPlayer = new Vimeo.Player(iframe);
                vimeoPlayer.on('timeupdate', (data) => {
                    setBuffering(false); 
                    updateProgress(data.seconds, data.duration);
                });
                vimeoPlayer.on('play', () => { isPlaying = true; updateUI(); setBuffering(false); });
                vimeoPlayer.on('pause', () => { isPlaying = false; updateUI(); });
                vimeoPlayer.on('bufferstart', () => setBuffering(true));
                vimeoPlayer.on('bufferend', () => setBuffering(false));
            }
            else if (type === 'youtube') {
                embedDiv.innerHTML = '<div id="yt-player"></div>';
                let cleanID = getYouTubeID(url);
                ytPlayer = new YT.Player('yt-player', {
                    height: '100%', width: '100%', videoId: cleanID,
                    playerVars: { 'controls': 0, 'rel': 0, 'modestbranding': 1, 'disablekb': 1, 'origin': window.location.origin },
                    events: {
                        'onReady': (e) => {
                            setBuffering(false);
                            updateInterval = setInterval(() => {
                                if(ytPlayer && ytPlayer.getCurrentTime) updateProgress(ytPlayer.getCurrentTime(), ytPlayer.getDuration());
                            }, 500);
                        },
                        'onStateChange': (e) => {
                            if(e.data === 3) setBuffering(true);
                            else setBuffering(false);
                            isPlaying = (e.data == YT.PlayerState.PLAYING);
                            updateUI();
                        }
                    }
                });
            }
        };

        window.togglePlay = function() {
            const directVid = document.getElementById('directVideo');
            if (playerMode === 'direct') {
                directVid.paused ? directVid.play() : directVid.pause();
            } else if (playerMode === 'vimeo' && vimeoPlayer) {
                vimeoPlayer.getPaused().then(p => p ? vimeoPlayer.play() : vimeoPlayer.pause());
            } else if (playerMode === 'youtube' && ytPlayer && ytPlayer.getPlayerState) {
                ytPlayer.getPlayerState() === 1 ? ytPlayer.pauseVideo() : ytPlayer.playVideo();
            }
        };

        window.skip = function(amount) {
            const directVid = document.getElementById('directVideo');
            if (playerMode === 'direct') directVid.currentTime += amount;
            else if (playerMode === 'vimeo' && vimeoPlayer) vimeoPlayer.setCurrentTime(t => t + amount);
            else if (playerMode === 'youtube' && ytPlayer) ytPlayer.seekTo(ytPlayer.getCurrentTime() + amount, true);
        };

        window.seekVideo = function() {
            const slider = document.getElementById('seekSlider');
            let val = parseFloat(slider.value);
            if (playerMode === 'direct') document.getElementById('directVideo').currentTime = val;
            else if (playerMode === 'vimeo' && vimeoPlayer) vimeoPlayer.setCurrentTime(val);
            else if (playerMode === 'youtube' && ytPlayer) ytPlayer.seekTo(val, true);
        };

        window.toggleMute = function() {
            const directVid = document.getElementById('directVideo');
            const icon = document.getElementById('volIcon');
            if(playerMode === 'direct') {
                directVid.muted = !directVid.muted;
                icon.className = directVid.muted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
            }
        };

        function updateProgress(curr, total) {
            if(isNaN(total) || total === 0) return;
            const slider = document.getElementById('seekSlider');
            if(slider) {
                slider.max = total;
                slider.value = curr;
                document.getElementById('currTime').innerText = formatTime(curr);
                document.getElementById('totalTime').innerText = formatTime(total);
            }
        }

        function updateUI() {
            const icon = document.querySelector('#playBtn i');
            if(icon) icon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
        }

        function formatTime(s) {
            let m = Math.floor(s / 60);
            let sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        }

        // Modified OpenPlayer to support Episodes
        window.openPlayer = function(movieId, epTitle=null, epS1=null, epS2=null) {
            const movie = allMovies[movieId];
            if (!movie) return;
            
            // Set Title (Movie Title or Series - Ep Title)
            document.getElementById('player-movie-title').textContent = epTitle ? `${movie.title} - ${epTitle}` : movie.title;
            
            const btnContainer = document.getElementById('server-buttons-container');
            btnContainer.innerHTML = '';
            
            const s1 = epS1 || movie.server1;
            const s2 = epS2 || movie.server2;

            if(s1) btnContainer.innerHTML += `<button class="sv-btn" id="btn-sv1" onclick="loadServer(this, 'direct', '${s1}')"><i class="fas fa-bolt"></i> HD Server 1</button>`;
            if(s2) btnContainer.innerHTML += `<button class="sv-btn" id="btn-sv2" onclick="loadServer(this, 'youtube', '${s2}')"><i class="fas fa-server"></i> Slow Server</button>`;
            if(!s1 && !s2) btnContainer.innerHTML = '<p class="text-gray-500">No servers available.</p>';
            
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById('watch-page').style.display = 'block';
            localStorage.setItem('last_page_id', 'watch-page');
            localStorage.setItem('last_movie_id', movieId);
            
            setTimeout(() => {
                if(document.getElementById('btn-sv1')) document.getElementById('btn-sv1').click();
                else if(document.getElementById('btn-sv2')) document.getElementById('btn-sv2').click();
            }, 300);
        };

        window.closePlayer = function() {
            const directVid = document.getElementById('directVideo');
            directVid.pause(); directVid.src = "";
            document.getElementById('embedContainer').innerHTML = '';
            document.getElementById('watch-page').style.display = 'none';
            const movieId = localStorage.getItem('last_movie_id');
            if(movieId && allMovies[movieId]) {
                showMovieDetails(movieId); 
            } else {
                showPage('home-page');
            }
        }

        // Modified Show Details for Series
        window.showMovieDetails = (movieId, push = true) => {
            if (!movieId || !allMovies[movieId]) return;
            const movie = allMovies[movieId];
            
            // Check Upcoming Status for Button with TIME
            const now = new Date();
            let isUpcoming = false;
            let releaseString = '';
            
            if(movie.isUpcoming && movie.releaseDate) {
                const releaseDate = new Date(movie.releaseDate);
                if(releaseDate > now) {
                    isUpcoming = true;
                    releaseString = releaseDate.toLocaleString(); // Shows Date + Time (AM/PM)
                }
            }

            // AD LOCATION 2: Above Button
            const adHtml = `
                <div class="ad-container my-2">
                     <iframe srcdoc="<script>
                          atOptions = {
                            'key' : 'aa465b71c480195a3ddce17207d3b9d7',
                            'format' : 'iframe',
                            'height' : 50,
                            'width' : 320,
                            'params' : {}
                          };
                        <\/script>
                        <script src='https://www.highperformanceformat.com/aa465b71c480195a3ddce17207d3b9d7/invoke.js'><\/script>"
                        width="320" height="50" scrolling="no" frameborder="0" style="border:none; overflow:hidden;"></iframe>
                </div>
            `;

            let actionHtml = '';

            if (isUpcoming) {
                actionHtml = `<button disabled class="block w-full text-center bg-gray-600 cursor-not-allowed text-gray-300 rounded-lg p-3 font-semibold my-4 opacity-75">
                     <i class="fas fa-calendar-alt mr-2"></i> Releases: ${releaseString}
                   </button>`;
            } else if (movie.contentType === 'series' && movie.seasons) {
                // SERIES UI LOGIC
                const seasons = Object.keys(movie.seasons);
                const seasonOptions = seasons.map((s, i) => `<option value="${s}">${s}</option>`).join('');
                
                actionHtml = `
                    <div class="mt-4 mb-2">
                        <label class="text-sm text-gray-400 font-medium">Select Season:</label>
                        <select id="season-selector" class="w-full bg-slate-800 text-white p-3 rounded-lg mt-1 border border-slate-700 outline-none focus:border-blue-500 transition-colors" onchange="renderEpisodes('${movieId}', this.value)">
                            ${seasonOptions}
                        </select>
                    </div>
                    <div id="episodes-list-container" class="space-y-2 max-h-64 overflow-y-auto mb-4 pr-1">
                        <!-- Episodes Rendered Here -->
                    </div>
                `;
            } else {
                // MOVIE UI LOGIC
                actionHtml = `<button onclick="openPlayer('${movieId}')" class="block w-full text-center bg-blue-600 hover:bg-blue-700 rounded-lg p-3 font-semibold my-4 shadow-lg shadow-blue-600/30 transition-all">
                     <i class="fas fa-play mr-2"></i> Watch Now
                   </button>`;
            }

            const contentEl = document.getElementById('movie-details-content');
            contentEl.innerHTML = `
                <div class="h-80 md:h-96 w-full relative">
                    <img src="${movie.posterUrl}" class="w-full h-full object-cover object-top absolute">
                    <div class="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent"></div>
                    <button onclick="goBack()" class="absolute top-4 left-4 bg-black/50 w-10 h-10 rounded-full flex items-center justify-center transition-transform hover:scale-110 z-10 border border-white/10">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="p-4 -mt-20 relative z-10">
                    <h2 class="text-3xl font-bold">${movie.title}</h2>
                    <div class="flex items-center space-x-4 text-gray-400 my-2">
                        <span>${movie.year}</span>
                        <div class="flex items-center"><i class="fas fa-star text-yellow-400 mr-1"></i><span>${movie.rating}</span></div>
                        ${movie.contentType === 'series' ? '<span class="bg-purple-600/80 text-white text-xs px-2 py-0.5 rounded border border-purple-400/30">Series</span>' : ''}
                    </div>
                    ${adHtml}
                    ${actionHtml}
                    <p class="text-gray-300 leading-relaxed">${movie.description}</p>
                    <h3 class="text-lg font-semibold mt-4 mb-2">Cast</h3>
                    <p class="text-gray-400">${movie.cast}</p>
                </div>
            `;
            
            pages.forEach(page => page.classList.toggle('active', page.id === 'movie-details-page'));
            window.scrollTo(0, 0);
            localStorage.setItem('last_page_id', 'movie-details-page');
            localStorage.setItem('last_movie_id', movieId);
            if(push) history.pushState({ page: 'movie-details-page', movieId: movieId }, null, "");

            // Initial Episode Render for Series (Default to first season)
            if (!isUpcoming && movie.contentType === 'series' && movie.seasons) {
                const firstSeason = Object.keys(movie.seasons)[0];
                renderEpisodes(movieId, firstSeason);
            }
        };

        window.renderEpisodes = (movieId, seasonKey) => {
            const container = document.getElementById('episodes-list-container');
            if(!container) return;
            const movie = allMovies[movieId];
            const episodes = movie.seasons[seasonKey];
            
            if(!episodes || episodes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No episodes found for this season.</p>';
                return;
            }

            container.innerHTML = episodes.map((ep, index) => `
                <div class="ep-list-item" onclick="openPlayer('${movieId}', '${ep.name}', '${ep.server1||''}', '${ep.server2||''}')">
                    <span class="text-sm font-medium text-gray-200 flex items-center gap-3">
                        <span class="text-gray-500 text-xs w-6 text-right">${index+1}</span> 
                        ${ep.name}
                    </span>
                    <i class="fas fa-play-circle text-2xl hover:text-blue-400 transition-colors"></i>
                </div>
            `).join('');
        };

        const loadInitialData = () => {
            db.ref('movies').on('value', s => { 
                allMovies = s.val() || {}; 
                if(Object.keys(allCategories).length) renderHomePage();
                
                // Refresh Banner to use Posters from Movies if available
                db.ref('banners').once('value', s => renderBanners(s.val()));

                const lastPage = localStorage.getItem('last_page_id');
                const lastMovie = localStorage.getItem('last_movie_id');
                
                if(lastMovie && allMovies[lastMovie]) {
                    if (lastPage === 'movie-details-page' || lastPage === 'watch-page') {
                        // Refresh details if data changed (e.g., new episodes added)
                        if(document.getElementById('movie-details-page').classList.contains('active')) {
                            showMovieDetails(lastMovie, false);
                        }
                    }
                }
            });
            
            db.ref('banners').on('value', s => renderBanners(s.val()));
            
            db.ref('categories').on('value', s => { 
                allCategories = s.val() || {}; 
                renderCategoriesPage(); 
                if(Object.keys(allMovies).length) renderHomePage(); 
            });

            // --- FETCH SETTINGS (Socials, Notifications, App Name) ---
            db.ref('socialLinks').on('value', s => renderSocials(s.val()));
            db.ref('notifications').on('value', s => renderNotifications(s.val()));
            db.ref('settings/appName').on('value', s => {
                const name = s.val() || "CineBD";
                
                // CACHE NAME FOR NEXT RELOAD
                localStorage.setItem('cinebd_app_name', name);
                document.title = name;

                document.querySelectorAll('.dynamic-app-name').forEach(el => {
                    const colored = name.replace(/^(.*?)(..)$/, '$1<span class="text-blue-500">$2</span>');
                    el.innerHTML = colored;
                });
            });
        };

    </script>
</body>
</html>
